{% extends "admin/dashboard-base.html" %}

{% block head %}
<style>
    #photo-preview {
        /* object-fit: cover;
        aspect-ratio: 1;

        /* Optional: constrain image size */
        /* max-block-size: 250px; */

        width: 80px;
        height: 80px;
        border-radius: 50%;
        margin-bottom: 10px;
        object-fit: cover;
        object-position: center right;
    }
</style>

<script>
    const csrf = {
        '{{ csrf.keys.name }}': "{{ csrf.name }}",
        '{{ csrf.keys.value }}': "{{ csrf.value }}"
    };
    document.addEventListener('alpine:init', () => {
        Alpine.data('createPhotoForm', () => ({
            cleave: null,
            formMessage: "",
            formLoading: false,
            formData: {
                description: "",
                slideshow: false,
                date: ""
            },

            init() {
                this.resetFormData();

                this.cleave = new Cleave('#date', {
                    date: true,
                    delimiter: '-',
                    datePattern: ['Y', 'm', 'd']
                });
            },

            resetFormData() {
                this.formData.description = "";
                this.formData.slideshow = false;
                this.formData.date = "";
            },

            showImgPreview(event) {
                var output = document.getElementById('photo-preview');
                if (event.target.files[0] === undefined) {
                    output.src = "";
                } else {
                    output.src = URL.createObjectURL(event.target.files[0]);
                    output.onload = function () {
                        URL.revokeObjectURL(output.src);
                    }
                }
            },

            submitForm() {
                this.formMessage = "";
                this.formLoading = true;

                const fileInput = document.querySelector('#photo');
                const mpFormData = new FormData();
                for (var key in this.formData) {
                    if (typeof this.formData[key] === 'boolean') {
                        mpFormData.append(key, +this.formData[key]);
                    } else {
                        mpFormData.append(key, this.formData[key]);
                    }
                }
                if (fileInput.value.trim().length) {
                    mpFormData.append('photo', fileInput.files[0]);
                }
                for (var key in csrf) {
                    mpFormData.append(key, csrf[key]);
                }

                fetch('/api/create-photo', {
                    method: "POST",
                    headers: {
                        Accept: "application/json",
                    },
                    body: mpFormData,
                })
                    .then((response) => {
                        if (response.ok) {
                            this.resetFormData();
                            window.location.replace("/admin/photos");
                        } else if (response.status < 500 && response.status >= 400) {
                            return response.json();
                        } else {
                            throw new Error('Server response was not OK');
                        }
                    })
                    .then((response) => {
                        if (response !== undefined) {
                            this.formMessage = response.error_message;
                        }
                    })
                    .catch((error) => {
                        this.formMessage = "Something went wrong.";
                    })
                    .finally(() => {
                        this.formLoading = false;
                    });
            }
        }))
    });
</script>
{% endblock %}

{% block content %}
<div>
    <h2>Create New Photo</h2>
    <hr />

    <form x-data="createPhotoForm" @submit.prevent="submitForm" x-cloak>
        <div class="alert alert-danger" role="alert" x-show="formMessage" x-text="formMessage"></div>

        <img id="photo-preview" onerror="this.src='/static/admin/img/default.png'" src="">
        <div class="row mb-3">
            <label for="photo" class="col-sm-2 col-form-label">Photo</label>
            <div class="col-sm-10">
                <input type="file" class="form-control-file" accept="image/png, image/jpeg" id="photo" name="photo"
                    @change="showImgPreview" required>
            </div>
        </div>
        <div class="row mb-3">
            <label for="date" class="col-sm-2 col-form-label">Date</label>
            <div class="col-sm-10">
                <input type="text" class="form-control" id="date" name="date" x-model="formData.date">
            </div>
        </div>
        <div class="row mb-3">
            <label for="description" class="col-sm-2 col-form-label">Description</label>
            <div class="col-sm-10">
                <textarea type="text" class="form-control" id="description" name="description"
                    x-model="formData.description" rows="3"></textarea>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-sm-10 offset-sm-2">
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="slideshow" name="slideshow" value="1"
                        x-model="formData.slideshow">
                    <label class="form-check-label" for="slideshow">
                        Slideshow
                    </label>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary" :disabled="formLoading"
            x-text="formLoading ? 'Loading...' : 'Submit'"></button>
    </form>
</div>
{% endblock %}